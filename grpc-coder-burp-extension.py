from burp import IBurpExtender
from burp import IContextMenuFactory, IContextMenuInvocation
from java.io import PrintWriter
from javax.swing import JMenuItem
import subprocess
import os


class BurpExtender(IBurpExtender, IContextMenuFactory):

    def registerExtenderCallbacks(self, callbacks):
        self.helpers = callbacks.getHelpers()
        callbacks.setExtensionName('gRPC-Web Coder')
        callbacks.registerContextMenuFactory(self)
        self.stdout = PrintWriter(callbacks.getStdout(), True)
        self.stderr = PrintWriter(callbacks.getStderr(), True)

    def createMenuItems(self, invocation):

        context = invocation.getInvocationContext()

        selected_payload = self.get_selected_text(invocation)
        payload_index = self.get_index_of_selected_text(invocation)
        if context == IContextMenuInvocation.CONTEXT_MESSAGE_EDITOR_REQUEST \
                or context == IContextMenuInvocation.CONTEXT_MESSAGE_VIEWER_REQUEST \
                and selected_payload is not None:

            label_encode = 'Encode'
            label_decode = 'Decode'
            menu_item_encoding = JMenuItem(label_encode, actionPerformed=self.encode_payload)
            menu_item_encoding.putClientProperty('grpc_selected_payload', selected_payload)
            menu_item_encoding.putClientProperty('grpc_selected_payload_index', payload_index)
            menu_item_decoding = JMenuItem(label_decode, actionPerformed=self.decode_payload)
            menu_item_decoding.putClientProperty('grpc_selected_payload', selected_payload)
            menu_item_decoding.putClientProperty('grpc_selected_payload_index', payload_index)
            return [menu_item_encoding, menu_item_decoding]

    def get_selected_text(self, invocation):
        request_text = invocation.getSelectedMessages()[0].getRequest().tostring()

        text_index = invocation.getSelectionBounds()
        start_index = text_index[0]
        end_index = text_index[1]

        selected_text = request_text[start_index:end_index]

        return selected_text

    def get_index_of_selected_text(self, invocation):
        request_text = invocation.getSelectedMessages()[0].getRequest().tostring()

        text_index = invocation.getSelectionBounds()
        start_index = text_index[0]
        end_index = text_index[1]

        return start_index, end_index

    def encode_payload(self, event):
        menu_item = event.getSource()
        selected_payload = menu_item.getClientProperty('grpc_selected_payload')

        temp_file_path = 'grpc_coder_output.txt'

        with open(temp_file_path, "w") as file:
            file.write(selected_payload.strip())

        command = "protoscope -s grpc_coder_output.txt | python grpc-coder.py --encode"
        output = subprocess.check_output(command, shell=True, stderr=subprocess.STDOUT)
        output = output.decode('utf-8')

        # Check if the file exists before attempting to remove it
        if os.path.exists(temp_file_path):
            try:
                os.remove(temp_file_path)
            except OSError as e:
                print("Error:", e)

        return None

    def decode_payload(self, event):
        menu_item = event.getSource()
        selected_payload = menu_item.getClientProperty('grpc_selected_payload')

        command = "echo " + selected_payload + "| python grpc-coder.py --decode | protoscope"
        output = subprocess.check_output(command, shell=True, stderr=subprocess.STDOUT)
        output = output.decode('utf-8')

        return None

    def pprint(self, text):
        self.stdout.println(text)
